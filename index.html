<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKM Application Ver 4.5 - SMAN 1 Muncar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="siswa.js"></script>
    <style>
        :root { 
            /* TEMA WARNA BIRU LANGIT */
            --primary-blue: #3498db; 
            --dark-blue: #2980b9; 
            --light-blue: #87CEEB;
            --bg-gradient: linear-gradient(135deg, #87CEEB 0%, #3498db 100%); 
            --text-dark: #2d3436;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            padding: 20px; 
            user-select: none; 
        }

        .card { 
            background: white; 
            width: 100%; 
            max-width: 500px; 
            padding: 40px 30px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.15); 
            text-align: center;
        }

        .logo-container { margin-bottom: 20px; }
        .logo-img { width: 100px; height: auto; margin-bottom: 10px; }
        .title-app { font-size: 1.4rem; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; text-transform: uppercase; }
        .subtitle-app { font-size: 0.9rem; color: var(--dark-blue); font-weight: 600; margin-bottom: 25px; }

        /* PASSWORD WRAPPER */
        .pass-wrapper { position: relative; width: 100%; margin-bottom: 25px; }
        .toggle-password {
            position: absolute; right: 15px; top: 14px; cursor: pointer;
            color: var(--dark-blue); font-size: 11px; font-weight: 800;
            background: #e1f5fe; padding: 4px 8px; border-radius: 6px;
        }

        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; font-size: 14px; outline: none; }
        .pass-input { margin-bottom: 0; } 

        .info-bar { background: #f0f8ff; padding: 15px; border-radius: 12px; border-left: 5px solid var(--primary-blue); margin-bottom: 15px; font-size: 13px; font-weight: 700; display: flex; justify-content: space-between; color: var(--dark-blue); }
        .progress-container { width: 100%; background: #edf2f7; height: 10px; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--primary-blue); width: 0%; transition: 0.3s; }
        .timer-box { background: #fff9db; color: #e67e22; padding: 10px; border-radius: 12px; text-align: center; font-weight: 700; margin-bottom: 20px; border: 1px solid #ffec99; }
        
        .opsi-label { display: flex; align-items: center; padding: 15px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; transition: 0.2s; background: #fff; text-align: left; }
        .opsi-label:hover { border-color: var(--light-blue); }
        .opsi-label input { display: none; }
        .checkmark { height: 20px; width: 20px; border: 2px solid #cbd5e0; margin-right: 15px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .radio-mark { border-radius: 50%; }
        .check-mark { border-radius: 4px; }
        input:checked + .checkmark { background: var(--primary-blue); border-color: var(--primary-blue); }
        input:checked + .checkmark::after { content: "✓"; color: white; font-size: 12px; font-weight: bold; }

        .btn-utama { width: 100%; padding: 16px; background: var(--primary-blue); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-utama:hover { background: var(--dark-blue); box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); }
        
        .footer { margin-top: 25px; color: white; font-size: 12px; text-align: center; line-height: 1.6; opacity: 0.9; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(41, 128, 185, 0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="border: 5px solid white; border-top: 5px solid transparent; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
    <p style="color: white; margin-top: 15px; font-weight: 700;">Sedang Memproses...</p>
</div>

<div class="card">
    <div id="box-login">
        <div class="logo-container">
            <img src="logo.png" class="logo-img" alt="Logo Sekolah" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/9/9c/Logo_Tut_Wuri_Handayani.png'">
            <h1 class="title-app">SMAN 1 MUNCAR</h1>
            <p class="subtitle-app">Sumatif Tengah Semester Genap</p>
        </div>

        <select id="sel-kelas" onchange="updateDaftarNama()">
            <option value="">-- Pilih Kelas --</option>
        </select>
        <select id="sel-nama">
            <option value="">-- Pilih Nama --</option>
        </select>
        
        <div class="pass-wrapper">
            <input type="password" id="pass" class="pass-input" placeholder="Password Siswa">
            <span class="toggle-password" onclick="intipPass()">LIHAT</span>
        </div>
        
        <button class="btn-utama" onclick="mulai()">Masuk Ujian</button>
    </div>

    <div id="box-kuis" style="display:none">
        <div class="info-bar">
            <span>SOAL <span id="txt-idx">1</span> / 40</span>
            <span id="txt-nama-display"></span>
        </div>
        <div class="progress-container"><div id="progress-fill"></div></div>
        <div class="timer-box" id="timer">Waktu Tersisa: --:--</div>
        <div id="soal-area"></div>
        <button class="btn-utama" style="margin-top:20px;" onclick="simpanKeLocal()">Simpan & Lanjut</button>
    </div>

    <div id="box-selesai" style="display:none; text-align:center;">
        <div style="font-size: 60px; margin-bottom: 10px;">✅</div>
        <h2 style="color: var(--dark-blue);">UJIAN SELESAI</h2>
        <p style="margin-bottom: 25px;">Jawaban Anda telah berhasil diunggah secara aman ke server.</p>
        <button class="btn-utama" onclick="logout()">Keluar Aplikasi</button>
    </div>
</div>

<div class="footer">
    AKM Ver. 4.5. | Design By Agus Tjakra © 2026<br>
    <strong>SMAN 1 Muncar - Banyuwangi</strong>
</div>

<script>
    const URL_APP = "https://script.google.com/macros/s/AKfycbzRLW7DVhItF6UpWVSqTyRfG94WIIpb-5n6YW6k3wAM3ag-Q9TsUmO9r2nLvaVkbA1l/exec"; 
    let dataSoal = []; let curIdx = 0; let currentUser = ""; let currentKelas = "";
    let sisaWaktu = 3600; let timerInterval;

    function intipPass() {
        const p = document.getElementById('pass');
        const t = document.querySelector('.toggle-password');
        if (p.type === "password") {
            p.type = "text";
            t.innerText = "TUTUP";
        } else {
            p.type = "password";
            t.innerText = "LIHAT";
        }
    }

    window.onload = () => {
        const savedUser = localStorage.getItem('active_user');
        if (savedUser) {
            currentUser = savedUser;
            currentKelas = localStorage.getItem('active_kelas');
            dataSoal = JSON.parse(localStorage.getItem('active_soal'));
            curIdx = JSON.parse(localStorage.getItem(`ans_${currentUser}`) || "[]").length;
            sisaWaktu = parseInt(localStorage.getItem('timer_sisa') || "3600");
            document.getElementById('box-login').style.display = 'none';
            document.getElementById('box-kuis').style.display = 'block';
            document.getElementById('txt-nama-display').innerText = currentUser;
            tampil(); timerInterval = setInterval(updateTimer, 1000);
        }
        
        if (typeof SISWA_BARU !== 'undefined') {
            const kls = [...new Set(SISWA_BARU.map(s => s.kelas))].sort();
            kls.forEach(k => {
                let o = document.createElement('option'); o.value = k; o.text = k;
                document.getElementById('sel-kelas').appendChild(o);
            });
        }
    };

    function updateDaftarNama() {
        const k = document.getElementById('sel-kelas').value;
        const sel = document.getElementById('sel-nama');
        sel.innerHTML = '<option value="">-- Pilih Nama --</option>';
        if (typeof SISWA_BARU !== 'undefined') {
            SISWA_BARU.filter(s => s.kelas === k).sort((a,b)=>a.nama.localeCompare(b.nama)).forEach(s => {
                let o = document.createElement('option'); o.value = s.nama; o.text = s.nama;
                sel.appendChild(o);
            });
        }
    }

    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    async function mulai() {
        const u = document.getElementById('sel-nama').value;
        const p = document.getElementById('pass').value;
        const k = document.getElementById('sel-kelas').value;
        
        if(!u || !p) return alert("Pilih Nama dan Isi Password!");
        
        const s = SISWA_BARU.find(x => x.nama === u && x.pass === p);
        if(!s) return alert("Login Gagal! Password mungkin salah.");

        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const respStatus = await fetch(`${URL_APP}?nama=${encodeURIComponent(u)}`);
            const status = await respStatus.json();
            if(status.jumlahDikerjakan >= 40) {
                document.getElementById('loading-overlay').style.display = 'none';
                return alert("Anda sudah menyelesaikan ujian!");
            }
            const respSoal = await fetch(`soal.json?v=${Date.now()}`);
            const gudangSoal = await respSoal.json();
            
            const bs = shuffle(gudangSoal.filter(x => x.tipe === 'benar-salah')).slice(0, 5);
            const pg = shuffle(gudangSoal.filter(x => x.tipe === 'pilihan-ganda')).slice(0, 15);
            const pk = shuffle(gudangSoal.filter(x => x.tipe === 'pg-kompleks')).slice(0, 15);
            const mj = shuffle(gudangSoal.filter(x => x.tipe === 'menjodohkan')).slice(0, 5);

            dataSoal = shuffle([...bs, ...pg, ...pk, ...mj]);
            currentUser = u; currentKelas = k;
            localStorage.setItem('active_user', u);
            localStorage.setItem('active_kelas', k);
            localStorage.setItem('active_soal', JSON.stringify(dataSoal));

            document.getElementById('box-login').style.display = 'none';
            document.getElementById('box-kuis').style.display = 'block';
            document.getElementById('txt-nama-display').innerText = u;
            tampil(); timerInterval = setInterval(updateTimer, 1000);
            document.getElementById('loading-overlay').style.display = 'none';
        } catch(e) { 
            alert("Koneksi gagal atau file soal.json tidak ditemukan."); 
            document.getElementById('loading-overlay').style.display = 'none'; 
        }
    }

    function tampil() {
        if(curIdx >= 40) return kirimJawabanAkhir();
        const s = dataSoal[curIdx];
        document.getElementById('txt-idx').innerText = curIdx + 1;
        document.getElementById('progress-fill').style.width = ((curIdx / 40) * 100) + "%";
        let h = `<h3 style="text-align:left; margin-bottom:20px;">${s.pertanyaan}</h3>`;
        if(s.tipe === "pilihan-ganda" || s.tipe === "benar-salah") {
            const opsi = s.tipe === "benar-salah" ? ["Benar", "Salah"] : s.opsi;
            opsi.forEach(o => { h += `<label class="opsi-label"><input type="radio" name="j" value="${o}"><span class="checkmark radio-mark"></span><span>${o}</span></label>`; });
        } else if(s.tipe === "pg-kompleks") {
            s.opsi.forEach(o => { h += `<label class="opsi-label"><input type="checkbox" name="j" value="${o}"><span class="checkmark check-mark"></span><span>${o}</span></label>`; });
        } else if(s.tipe === "menjodohkan") {
            s.kiri.forEach(k => { h += `<div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; background:#f0f7ff; padding:10px; border-radius:8px; border:1px solid #d1e9ff;"><span>${k}</span><select class="match-sel" data-kiri="${k}" style="padding:5px; width:55%; margin:0;"><option value="">-- Pilih --</option>${s.kanan.map(kn => `<option value="${kn}">${kn}</option>`).join('')}</select></div>`; });
        }
        document.getElementById('soal-area').innerHTML = h;
    }

    function simpanKeLocal() {
        const s = dataSoal[curIdx];
        let jawaban = ""; let stat = "Salah";
        if(s.tipe === "pilihan-ganda" || s.tipe === "benar-salah") {
            const sel = document.querySelector('input[name="j"]:checked');
            if(!sel) return alert("Pilih jawaban!");
            jawaban = sel.value; stat = (jawaban === s.kunci) ? "Benar" : "Salah";
        } else if(s.tipe === "pg-kompleks") {
            let sels = []; document.querySelectorAll('input[name="j"]:checked').forEach(i => sels.push(i.value));
            if(sels.length === 0) return alert("Pilih minimal satu!");
            jawaban = sels.sort().join(","); stat = (jawaban === s.kunci.sort().join(",")) ? "Benar" : "Salah";
        } else if(s.tipe === "menjodohkan") {
            let res = {}; let full = true;
            document.querySelectorAll('.match-sel').forEach(sl => { if(!sl.value) full = false; res[sl.dataset.kiri] = sl.value; });
            if(!full) return alert("Lengkapi semua pasangan!");
            jawaban = JSON.stringify(res); stat = (jawaban === JSON.stringify(s.kunci)) ? "Benar" : "Salah";
        }
        let ans = JSON.parse(localStorage.getItem(`ans_${currentUser}`) || "[]");
        ans.push({ nama: currentUser, kelas: currentKelas, id_soal: s.id, jawaban: jawaban, status: stat });
        localStorage.setItem(`ans_${currentUser}`, JSON.stringify(ans));
        curIdx++; tampil();
    }

    async function kirimJawabanAkhir() {
        document.getElementById('loading-overlay').style.display = 'flex';
        const ans = JSON.parse(localStorage.getItem(`ans_${currentUser}`) || "[]");
        try {
            await fetch(URL_APP, { method: "POST", mode: "no-cors", body: JSON.stringify(ans) });
            localStorage.clear();
            document.getElementById('box-kuis').style.display = 'none';
            document.getElementById('box-selesai').style.display = 'block';
        } catch(e) { alert("Gagal mengirim jawaban ke server."); }
        document.getElementById('loading-overlay').style.display = 'none';
    }

    function updateTimer() { 
        sisaWaktu--; 
        localStorage.setItem('timer_sisa', sisaWaktu); 
        let m = Math.floor(sisaWaktu / 60); 
        let s = sisaWaktu % 60; 
        document.getElementById('timer').innerText = `Waktu Tersisa: ${m}:${s < 10 ? '0'+s : s}`; 
        if(sisaWaktu <= 0) { clearInterval(timerInterval); kirimJawabanAkhir(); } 
    }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
